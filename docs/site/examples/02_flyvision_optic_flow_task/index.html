
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://flyvis.github.io/examples/02_flyvision_optic_flow_task/">
      
      
        <link rel="prev" href="../01_flyvision_connectome/">
      
      
        <link rel="next" href="../03_flyvision_flash_responses/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.38">
    
    
      
        <title>Train the network - Flyvis</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8c3ca2c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#optic-flow-task" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Flyvis" class="md-header__button md-logo" aria-label="Flyvis" data-md-component="logo">
      
  <img src="../../images/logo_hexagon.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Flyvis
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Train the network
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Flyvis" class="md-nav__button md-logo" aria-label="Flyvis" data-md-component="logo">
      
  <img src="../../images/logo_hexagon.jpg" alt="logo">

    </a>
    Flyvis
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../01_flyvision_connectome/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Explore the connectome
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Train the network
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../03_flyvision_flash_responses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flash responses
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../04_flyvision_moving_edge_responses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Moving edge responses
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../05_flyvision_umap_and_clustering_models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ensemble clustering
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../06_flyvision_maximally_excitatory_stimuli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Maximally excitatory stimuli
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../07_flyvision_providing_custom_stimuli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Custom stimuli
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contribute/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/connectome/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Connectome
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/network/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Network
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/sintel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sintel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/tasks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Task
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/solver/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Task Training
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/flash_responses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flash Responses
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/moving_stimulus_responses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Moving Stimulus Responses
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/ensemble_clustering/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ensemble Clustering
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/optimal_stimuli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimal Stimuli
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FAQ
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../acknowledgements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Acknowledgements
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">load_ext</span> <span class="n">autoreload</span>
<span class="o">%</span><span class="n">autoreload</span> <span class="mi">2</span>
</code></pre></div>
<h1 id="optic-flow-task">Optic flow task<a class="headerlink" href="#optic-flow-task" title="Permanent link">&para;</a></h1>
<p>This notebook illustrates the optic flow task and how to use it with our pretrained fly visual system model and decoder.</p>
<p><strong>Select GPU runtime</strong></p>
<p>To run the notebook on a GPU select Menu -&gt; Runtime -&gt; Change runtime type -&gt; GPU.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># @markdown **Check access to GPU**</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">google.colab</span>

    <span class="n">IN_COLAB</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">IN_COLAB</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">torch</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">cuda_name</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_name</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Name of the assigned GPU / CUDA device: </span><span class="si">{</span><span class="n">cuda_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">warnings</span>

        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;You have not selected Runtime Type: &#39;GPU&#39; or Google could not assign you one. Please revisit the settings as described above or proceed on CPU (slow).&quot;</span>
        <span class="p">)</span>
</code></pre></div>
<p><strong>Install Flyvis</strong></p>
<p>The notebook requires installing our package <code>flyvis</code>. You may need to restart your session after running the code block below with Menu -&gt; Runtime -&gt; Restart session. Then, imports from <code>flyvis</code> should succeed without issue.</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="c1">#@markdown **Install Flyvis**</span>
    <span class="o">%%</span><span class="n">capture</span>
    <span class="err">!</span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">flyvis</span><span class="o">/</span><span class="n">flyvis</span><span class="o">-</span><span class="n">dev</span><span class="o">.</span><span class="n">git</span>
    <span class="o">%</span><span class="n">cd</span> <span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">flyvis</span><span class="o">-</span><span class="n">dev</span>
    <span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">e</span> <span class="o">.</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># basic imports</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
</code></pre></div>
<h1 id="the-sintel-dataset">The Sintel dataset<a class="headerlink" href="#the-sintel-dataset" title="Permanent link">&para;</a></h1>
<p>We use the Sintel dataset to train out models as described in the paper. More infos about the Sintel dataset can be found on the official Sintel website: <a href="http://sintel.is.tue.mpg.de/">http://sintel.is.tue.mpg.de/</a>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">flyvision.datasets.sintel</span> <span class="kn">import</span> <span class="n">MultiTaskSintel</span>
<span class="kn">from</span> <span class="nn">flyvision.animations.sintel</span> <span class="kn">import</span> <span class="n">SintelSample</span>

<span class="o">%</span><span class="n">load_ext</span> <span class="n">autoreload</span>
<span class="o">%</span><span class="n">autoreload</span> <span class="mi">2</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>The autoreload extension is already loaded. To reload it, use:
  %reload_ext autoreload
</code></pre></div>

<p>The class <code>MultiTaskSintel</code> loads, preprocesses, renders, and augments the sintel data. It adheres to the pytorch dataset primitive. It provides the interface to the input data and the output data for the flyvision networks. Note: the fly-eye rendering we use here, we introduce in the notebook on creating custom stimuli already.</p>
<p>This is the full setting:</p>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">MultiTaskSintel</span><span class="p">(</span><span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">],</span>
        <span class="n">boxfilter</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">13</span><span class="p">),</span>
        <span class="c1"># Because the fly eye rendering is square </span>
        <span class="c1"># and sintel is wide, we can crop sintel </span>
        <span class="c1"># in width and render three sequences from one. </span>
        <span class="c1"># This allows us to statically augment our dataset </span>
        <span class="c1"># a bit already before we proceed with the random augmentations. </span>
        <span class="c1"># We end up with 3 * 23 sequences. </span>
        <span class="n">vertical_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">n_frames</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span>
        <span class="n">center_crop_fraction</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
        <span class="n">dt</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">augment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="c1"># From sequences with more than n_frames, we randomly sample the start frame.</span>
        <span class="n">random_temporal_crop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">all_frames</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="c1"># We resample movie frames to the effective framerate given by 1/dt</span>
        <span class="n">resampling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="c1"># We interpolate the flow arrows to 1/dt.</span>
        <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="c1"># We flip with equal probability (using one flip-axis).</span>
        <span class="n">p_flip</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="c1"># We rotate with equal probability (using five fold rotation symmetry of the hex-grid).</span>
        <span class="n">p_rot</span><span class="o">=</span><span class="mi">5</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span>
        <span class="c1"># We randomly adjust contrast and brightness.</span>
        <span class="n">contrast_std</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">brightness_std</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="c1"># We add random white noise pixelweise.</span>
        <span class="n">gaussian_white_noise</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span>
        <span class="n">gamma_std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">_init_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">unittest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">flip_axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">task_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># The `dataset.arg_df` tracks the sequence index, identity etc.</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">arg_df</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>index</th>
      <th>original_index</th>
      <th>name</th>
      <th>original_n_frames</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>sequence_00_alley_1_split_00</td>
      <td>50</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>0</td>
      <td>sequence_00_alley_1_split_01</td>
      <td>50</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>0</td>
      <td>sequence_00_alley_1_split_02</td>
      <td>50</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>1</td>
      <td>sequence_01_alley_2_split_00</td>
      <td>50</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>1</td>
      <td>sequence_01_alley_2_split_01</td>
      <td>50</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>64</th>
      <td>64</td>
      <td>21</td>
      <td>sequence_21_temple_2_split_01</td>
      <td>50</td>
    </tr>
    <tr>
      <th>65</th>
      <td>65</td>
      <td>21</td>
      <td>sequence_21_temple_2_split_02</td>
      <td>50</td>
    </tr>
    <tr>
      <th>66</th>
      <td>66</td>
      <td>22</td>
      <td>sequence_22_temple_3_split_00</td>
      <td>50</td>
    </tr>
    <tr>
      <th>67</th>
      <td>67</td>
      <td>22</td>
      <td>sequence_22_temple_3_split_01</td>
      <td>50</td>
    </tr>
    <tr>
      <th>68</th>
      <td>68</td>
      <td>22</td>
      <td>sequence_22_temple_3_split_02</td>
      <td>50</td>
    </tr>
  </tbody>
</table>
<p>69 rows × 4 columns</p>
</div>

<h2 id="single-sample">Single sample<a class="headerlink" href="#single-sample" title="Permanent link">&para;</a></h2>
<p>First, let&rsquo;s chunk this into smaller digestable pieces.</p>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">MultiTaskSintel</span><span class="p">(</span>
    <span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">],</span>
    <span class="n">boxfilter</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">13</span><span class="p">),</span>
    <span class="n">vertical_splits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<p>The first sample. For the target, the pixel-accurate motion vectors, the color indicates the direction of motion of the respective input pixel. The saturation indicates the magnitude of motion.</p>
<div class="highlight"><pre><span></span><code><span class="n">lum</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lum&quot;</span><span class="p">]</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;flow&quot;</span><span class="p">]</span>

<span class="n">animation</span> <span class="o">=</span> <span class="n">SintelSample</span><span class="p">(</span><span class="n">lum</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">flow</span><span class="p">[</span><span class="kc">None</span><span class="p">])</span>
<span class="n">animation</span><span class="o">.</span><span class="n">animate_in_notebook</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="../02_flyvision_optic_flow_task_files/02_flyvision_optic_flow_task_17_0.png" /></p>
<p>Sintel has more groundtruth annotations. We support depth and flow because we know with certainty that these are relevant for the fly.</p>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">MultiTaskSintel</span><span class="p">(</span>
    <span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">],</span>
    <span class="n">boxfilter</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">13</span><span class="p">),</span>
    <span class="n">vertical_splits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">lum1</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lum&quot;</span><span class="p">]</span>
<span class="n">depth1</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span>

<span class="n">animation</span> <span class="o">=</span> <span class="n">SintelSample</span><span class="p">(</span><span class="n">lum1</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">depth1</span><span class="p">[</span><span class="kc">None</span><span class="p">])</span>
<span class="n">animation</span><span class="o">.</span><span class="n">animate_in_notebook</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="../02_flyvision_optic_flow_task_files/02_flyvision_optic_flow_task_20_0.png" /></p>
<h1 id="augmenting-the-dataset-step-by-step">Augmenting the dataset step-by-step<a class="headerlink" href="#augmenting-the-dataset-step-by-step" title="Permanent link">&para;</a></h1>
<p>We apply rich augmentations to the dataset of naturalistic sequences because the dataset is otherwise relatively small. This might lead to overfitting to, e.g., predicting motion mostly into well-represented directons or of objects of specific contrasts etc. Using rich augmentations, we &lsquo;ask&rsquo; the network to generalize better and invariantly compute motion regardless of direction, contrast, brightness, pixel noise, temporal appearance etc.</p>
<h2 id="vertical-splits">Vertical splits<a class="headerlink" href="#vertical-splits" title="Permanent link">&para;</a></h2>
<p>First, we split each sequence into three sequences vertically to leverage a wider extent of the video than if we would only render the center. We precompute these renderings.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">flyvision.plots.plots</span> <span class="kn">import</span> <span class="n">quick_hex_scatter</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">MultiTaskSintel</span><span class="p">(</span>
    <span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">],</span>
    <span class="n">boxfilter</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">13</span><span class="p">),</span>
    <span class="n">vertical_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<p>Sintel has 23 movie sequences originally.</p>
<div class="highlight"><pre><span></span><code><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">arg_df</span><span class="o">.</span><span class="n">original_index</span><span class="p">))</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>23
</code></pre></div>

<p>Each original sequence is 436 pixel in height times 1024 pixel in width in cartesian coordinates.</p>
<div class="highlight"><pre><span></span><code><span class="n">sequence</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">cartesian_sequence</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vertical_splits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">center_crop_fraction</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>(1, 49, 436, 1024)
</code></pre></div>

<p>With the vertical crops, we end up with 3 * 23 sequences. The <code>dataset.arg_df</code> tracks the sequence index, identity etc.</p>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span><span class="o">.</span><span class="n">arg_df</span>
</code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>index</th>
      <th>original_index</th>
      <th>name</th>
      <th>original_n_frames</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>sequence_00_alley_1_split_00</td>
      <td>50</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>0</td>
      <td>sequence_00_alley_1_split_01</td>
      <td>50</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>0</td>
      <td>sequence_00_alley_1_split_02</td>
      <td>50</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>1</td>
      <td>sequence_01_alley_2_split_00</td>
      <td>50</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>1</td>
      <td>sequence_01_alley_2_split_01</td>
      <td>50</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>64</th>
      <td>64</td>
      <td>21</td>
      <td>sequence_21_temple_2_split_01</td>
      <td>50</td>
    </tr>
    <tr>
      <th>65</th>
      <td>65</td>
      <td>21</td>
      <td>sequence_21_temple_2_split_02</td>
      <td>50</td>
    </tr>
    <tr>
      <th>66</th>
      <td>66</td>
      <td>22</td>
      <td>sequence_22_temple_3_split_00</td>
      <td>50</td>
    </tr>
    <tr>
      <th>67</th>
      <td>67</td>
      <td>22</td>
      <td>sequence_22_temple_3_split_01</td>
      <td>50</td>
    </tr>
    <tr>
      <th>68</th>
      <td>68</td>
      <td>22</td>
      <td>sequence_22_temple_3_split_02</td>
      <td>50</td>
    </tr>
  </tbody>
</table>
<p>69 rows × 4 columns</p>
</div>

<div class="highlight"><pre><span></span><code><span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">binary_r</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../02_flyvision_optic_flow_task_files/02_flyvision_optic_flow_task_33_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">quick_hex_scatter</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">quick_hex_scatter</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;lum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">quick_hex_scatter</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;lum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../02_flyvision_optic_flow_task_files/02_flyvision_optic_flow_task_34_0.png" /></p>
<h2 id="random-temporal-crops">Random temporal crops<a class="headerlink" href="#random-temporal-crops" title="Permanent link">&para;</a></h2>
<p>We train on 19 frames ~ 792ms movie. Most sequences have 49 frames. To use the whole temporal content, we stochastically sample start and end frame ~ ((1, 19), (2, 20), &hellip;, (31, 49)).</p>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">MultiTaskSintel</span><span class="p">(</span>
    <span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">],</span>
    <span class="n">boxfilter</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">13</span><span class="p">),</span>
    <span class="n">vertical_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">n_frames</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">augment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">random_temporal_crop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">all_frames</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">resampling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">interpolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">p_flip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">p_rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">contrast_std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">brightness_std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">gaussian_white_noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># These two samples from the same original sequence should have stochastically different start and end frames.</span>
<span class="n">lum1</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lum&#39;</span><span class="p">]</span>
<span class="n">lum2</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lum&#39;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">animation</span> <span class="o">=</span> <span class="n">SintelSample</span><span class="p">(</span><span class="n">lum1</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">lum2</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">title2</span><span class="o">=</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>
<span class="n">animation</span><span class="o">.</span><span class="n">animate_in_notebook</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="../02_flyvision_optic_flow_task_files/02_flyvision_optic_flow_task_39_0.png" /></p>
<h2 id="flips-and-rotations">Flips and rotations<a class="headerlink" href="#flips-and-rotations" title="Permanent link">&para;</a></h2>
<p>Next, we flip stochastically across 2 axes and or rotate a random number of times around the center. We implement this to be fast to do so at runtime.</p>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">MultiTaskSintel</span><span class="p">(</span>
    <span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">],</span>
    <span class="n">boxfilter</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">13</span><span class="p">),</span>
    <span class="n">vertical_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">n_frames</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">augment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">random_temporal_crop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">all_frames</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">resampling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">interpolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">p_flip</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">p_rot</span><span class="o">=</span><span class="mi">5</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span>
    <span class="n">contrast_std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">brightness_std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">gaussian_white_noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># These two samples from the same original sequence should have stochastically different orientation.</span>
<span class="n">lum1</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lum&#39;</span><span class="p">]</span>
<span class="n">lum2</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lum&#39;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">animation</span> <span class="o">=</span> <span class="n">SintelSample</span><span class="p">(</span><span class="n">lum1</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">lum2</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">title2</span><span class="o">=</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>
<span class="n">animation</span><span class="o">.</span><span class="n">animate_in_notebook</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="../02_flyvision_optic_flow_task_files/02_flyvision_optic_flow_task_44_0.png" /></p>
<p>Flow vectors need to be flipped and rotated accordingly.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># These two samples from the same original sequence should have stochastically different orientation.</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">lum1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lum&#39;</span><span class="p">]</span>
<span class="n">flow1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">animation</span> <span class="o">=</span> <span class="n">SintelSample</span><span class="p">(</span><span class="n">lum1</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">flow1</span><span class="p">[</span><span class="kc">None</span><span class="p">])</span>
<span class="n">animation</span><span class="o">.</span><span class="n">animate_in_notebook</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="../02_flyvision_optic_flow_task_files/02_flyvision_optic_flow_task_47_0.png" /></p>
<h2 id="further-augmentations">Further augmentations<a class="headerlink" href="#further-augmentations" title="Permanent link">&para;</a></h2>
<p>Besides that, we also augment the input with random contrasts and brightnesses and random gaussian pixel noise, while the motion stays the same. This pretends that the same motion takes place under different illumination conditions and signal to noise ratios.  </p>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">MultiTaskSintel</span><span class="p">(</span>
    <span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">],</span>
    <span class="n">boxfilter</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">13</span><span class="p">),</span>
    <span class="n">vertical_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">n_frames</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">augment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">random_temporal_crop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">all_frames</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">resampling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">interpolate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">p_flip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">p_rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">contrast_std</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">brightness_std</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">gaussian_white_noise</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># These two samples from the same original sequence have </span>
<span class="c1"># stochastically different contrast, brightness and pixel-wise noise.</span>
<span class="n">lum1</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lum&#39;</span><span class="p">]</span>
<span class="n">lum2</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lum&#39;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">animation</span> <span class="o">=</span> <span class="n">SintelSample</span><span class="p">(</span><span class="n">lum1</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">lum2</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">title2</span><span class="o">=</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>
<span class="n">animation</span><span class="o">.</span><span class="n">animate_in_notebook</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="../02_flyvision_optic_flow_task_files/02_flyvision_optic_flow_task_52_0.png" /></p>
<h1 id="framerate-of-the-dataset-and-integration-time-step">Framerate of the dataset and integration time step<a class="headerlink" href="#framerate-of-the-dataset-and-integration-time-step" title="Permanent link">&para;</a></h1>
<p>The Sintel dataset is originally rendered at 24 frames per second, i.e., one frame every 42ms. The fruit fly neurons are able to respond to temporal differences as fast as 5-20ms. Therefore, we resample every frame multiple times to pretend that the movie was originally sampled at such a faster framerate. For the motion fields, we interpolate flow vectors in time instead of resampling them, which hopefully gives a better learning signal to the network. We have to trade-off speed of the numerical integration and memory consumption during optimization with the simulation accuracy by choosing time steps between 5-20ms. We chose to train networks at the upper bount of 20ms and evaluate them more accurately at 5-10ms.</p>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">MultiTaskSintel</span><span class="p">(</span>
    <span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">],</span>
    <span class="n">boxfilter</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">13</span><span class="p">),</span>
    <span class="n">vertical_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">n_frames</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">resampling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Now, every input frame appears twice and target frames are interpolated.</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">lum1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lum&#39;</span><span class="p">]</span>
<span class="n">flow1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;flow&#39;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">animation</span> <span class="o">=</span> <span class="n">SintelSample</span><span class="p">(</span><span class="n">lum1</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">flow1</span><span class="p">[</span><span class="kc">None</span><span class="p">])</span>
<span class="n">animation</span><span class="o">.</span><span class="n">animate_in_notebook</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="../02_flyvision_optic_flow_task_files/02_flyvision_optic_flow_task_57_0.png" /></p>
<h1 id="computing-responses-to-the-sintel-data">Computing responses to the Sintel data<a class="headerlink" href="#computing-responses-to-the-sintel-data" title="Permanent link">&para;</a></h1>
<p>Before we get to training a network, we look at a few responses to these type of sequences of individual neurons.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">flyvision.network</span> <span class="kn">import</span> <span class="n">NetworkView</span><span class="p">,</span> <span class="n">Network</span>
<span class="kn">from</span> <span class="nn">flyvision.utils.activity_utils</span> <span class="kn">import</span> <span class="n">LayerActivity</span>

<span class="kn">from</span> <span class="nn">flyvision.datasets.sintel</span> <span class="kn">import</span> <span class="n">MultiTaskSintel</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># new network instance</span>
<span class="n">network</span> <span class="o">=</span> <span class="n">Network</span><span class="p">()</span>

<span class="c1"># Alternative: uncomment to use a pretrained network</span>
<span class="c1"># network_view = NetworkView(results_dir / &quot;flow/0000/000&quot;)</span>
<span class="c1"># network = network_view.init_network(network)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[2024-09-23 15:50:20] network:252 Initialized network with NumberOfParams(free=734, fixed=2959) parameters.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">layer_activity</span> <span class="o">=</span> <span class="n">LayerActivity</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">network</span><span class="o">.</span><span class="n">connectome</span><span class="p">,</span> <span class="n">keepref</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">MultiTaskSintel</span><span class="p">(</span>
    <span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">],</span>
    <span class="n">boxfilter</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">13</span><span class="p">),</span>
    <span class="n">vertical_splits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_frames</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">resampling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">stationary_state</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">fade_in_state</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lum&quot;</span><span class="p">][[</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">responses</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lum&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">],</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">initial_state</span><span class="o">=</span><span class="n">stationary_state</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">layer_activity</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">layer_activity</span><span class="o">.</span><span class="n">central</span><span class="o">.</span><span class="n">T4c</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time in s&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;voltage (a.u.)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;response of central T4c cell&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>Text(0.5, 1.0, &#39;response of central T4c cell&#39;)
</code></pre></div>

<p><img alt="png" src="../02_flyvision_optic_flow_task_files/02_flyvision_optic_flow_task_65_1.png" /></p>
<h1 id="decoding-the-task-from-neural-activity">Decoding the task from neural activity<a class="headerlink" href="#decoding-the-task-from-neural-activity" title="Permanent link">&para;</a></h1>
<p>We need to predict the pixel-accurate flow field that Sintel gives us. For that we decode the voltages of a bunch of cell types. The decoder and the network are trained end-to-end. Here an example of a forward pass through the whole pipeline in code.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">flyvision.network</span> <span class="kn">import</span> <span class="n">NetworkView</span>
<span class="kn">from</span> <span class="nn">flyvision.utils.activity_utils</span> <span class="kn">import</span> <span class="n">LayerActivity</span>

<span class="kn">from</span> <span class="nn">flyvision.datasets.sintel</span> <span class="kn">import</span> <span class="n">MultiTaskSintel</span>
<span class="kn">from</span> <span class="nn">flyvision.decoder</span> <span class="kn">import</span> <span class="n">DecoderGAVP</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">network</span> <span class="o">=</span> <span class="n">Network</span><span class="p">()</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[2024-09-23 15:50:36] network:252 Initialized network with NumberOfParams(free=734, fixed=2959) parameters.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">decoder</span> <span class="o">=</span> <span class="n">DecoderGAVP</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">connectome</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[2024-09-23 15:50:40] decoder:213 Initialized decoder with NumberOfParams(free=7427, fixed=0) parameters.
[2024-09-23 15:50:40] decoder:214 DecoderGAVP(
  (base): Sequential(
    (0): Conv2dHexSpace(34, 8, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2))
    (1): BatchNorm2d(8, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (2): Softplus(beta=1, threshold=20)
    (3): Dropout(p=0.5, inplace=False)
  )
  (decoder): Sequential(
    (0): Conv2dHexSpace(8, 3, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2))
  )
  (head): Sequential()
)
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">MultiTaskSintel</span><span class="p">(</span>
    <span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">],</span>
    <span class="n">boxfilter</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">13</span><span class="p">),</span>
    <span class="n">vertical_splits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">all_frames</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">resampling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">data</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">lum</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lum&quot;</span><span class="p">]</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">]</span>

<span class="n">stationary_state</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">fade_in_state</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">lum</span><span class="p">[[</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">responses</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">lum</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">initial_state</span><span class="o">=</span><span class="n">stationary_state</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span> <span class="o">=</span> <span class="n">decoder</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span>
</code></pre></div>
<p>We predict motion with an untrained decoder from an untrained network with randomly initialized parameters. 
We do not expect this to work.</p>
<div class="highlight"><pre><span></span><code><span class="n">animation</span> <span class="o">=</span> <span class="n">SintelSample</span><span class="p">(</span><span class="n">lum</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">flow</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">prediction</span><span class="o">=</span><span class="n">y_pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
<span class="n">animation</span><span class="o">.</span><span class="n">animate_in_notebook</span><span class="p">(</span><span class="n">frames</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[::</span><span class="mi">10</span><span class="p">])</span>
</code></pre></div>
<p><img alt="png" src="../02_flyvision_optic_flow_task_files/02_flyvision_optic_flow_task_74_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="p">((</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">flow</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>tensor(1.0214, device=&#39;cuda:0&#39;, grad_fn=&lt;MeanBackward0&gt;)
</code></pre></div>

<h1 id="training-network-and-decoder-on-a-single-batch">Training network and decoder on a single batch<a class="headerlink" href="#training-network-and-decoder-on-a-single-batch" title="Permanent link">&para;</a></h1>
<p>We now train the network on a single batch to validate that the pipeline works. We do not expect these networks to generalize their function.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">torch.optim</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>

<span class="kn">from</span> <span class="nn">flyvision.network</span> <span class="kn">import</span> <span class="n">NetworkView</span><span class="p">,</span> <span class="n">Network</span>
<span class="kn">from</span> <span class="nn">flyvision.decoder</span> <span class="kn">import</span> <span class="n">DecoderGAVP</span>
<span class="kn">from</span> <span class="nn">flyvision.utils.activity_utils</span> <span class="kn">import</span> <span class="n">LayerActivity</span>

<span class="kn">from</span> <span class="nn">flyvision.datasets.sintel</span> <span class="kn">import</span> <span class="n">MultiTaskSintel</span>
<span class="kn">from</span> <span class="nn">flyvision.objectives</span> <span class="kn">import</span> <span class="n">l2norm</span><span class="p">,</span> <span class="n">epe</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">network</span> <span class="o">=</span> <span class="n">Network</span><span class="p">()</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[2024-09-23 15:51:17] network:252 Initialized network with NumberOfParams(free=734, fixed=2959) parameters.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">decoder</span> <span class="o">=</span> <span class="n">DecoderGAVP</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">connectome</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[2024-09-23 15:51:21] decoder:213 Initialized decoder with NumberOfParams(free=7427, fixed=0) parameters.
[2024-09-23 15:51:21] decoder:214 DecoderGAVP(
  (base): Sequential(
    (0): Conv2dHexSpace(34, 8, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2))
    (1): BatchNorm2d(8, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (2): Softplus(beta=1, threshold=20)
    (3): Dropout(p=0.5, inplace=False)
  )
  (decoder): Sequential(
    (0): Conv2dHexSpace(8, 3, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2))
  )
  (head): Sequential()
)
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">MultiTaskSintel</span><span class="p">(</span>
    <span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">],</span>
    <span class="n">boxfilter</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">13</span><span class="p">),</span>
    <span class="n">vertical_splits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_frames</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">resampling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">t_pre</span><span class="o">=</span><span class="mf">0.5</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">50</span>
<span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span>
<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">((</span><span class="o">*</span><span class="n">network</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="o">*</span><span class="n">decoder</span><span class="o">.</span><span class="n">parameters</span><span class="p">()),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">train_loader</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">epe</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">initial_state</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">steady_state</span><span class="p">(</span><span class="n">t_pre</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>

<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">)):</span>
    <span class="n">lum</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;lum&quot;</span><span class="p">]</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">]</span>


    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">network</span><span class="o">.</span><span class="n">stimulus</span><span class="o">.</span><span class="n">zero</span><span class="p">()</span>
    <span class="n">network</span><span class="o">.</span><span class="n">stimulus</span><span class="o">.</span><span class="n">add_input</span><span class="p">(</span><span class="n">lum</span><span class="p">)</span>

    <span class="n">activity</span> <span class="o">=</span> <span class="n">network</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">stimulus</span><span class="p">(),</span> <span class="n">dt</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">50</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">initial_state</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">decoder</span><span class="p">(</span><span class="n">activity</span><span class="p">)</span>

    <span class="n">batch_error</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">flow</span><span class="p">)</span>
    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_error</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">batch_error</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>  0%|          | 0/1000 [00:00&lt;?, ?it/s]
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[&lt;matplotlib.lines.Line2D at 0x7f7f5467f580&gt;]
</code></pre></div>

<p><img alt="png" src="../02_flyvision_optic_flow_task_files/02_flyvision_optic_flow_task_86_1.png" /></p>
<p>We expect that the prediction from this overfitted network on the sample it was trained on is ok.</p>
<div class="highlight"><pre><span></span><code><span class="n">data</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">lum</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;lum&quot;</span><span class="p">]</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">]</span>

<span class="n">stationary_state</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">fade_in_state</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">lum</span><span class="p">[[</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">responses</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">lum</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">initial_state</span><span class="o">=</span><span class="n">stationary_state</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span> <span class="o">=</span> <span class="n">decoder</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">animation</span> <span class="o">=</span> <span class="n">SintelSample</span><span class="p">(</span><span class="n">lum</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">flow</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">prediction</span><span class="o">=</span><span class="n">y_pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
<span class="n">animation</span><span class="o">.</span><span class="n">animate_in_notebook</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="../02_flyvision_optic_flow_task_files/02_flyvision_optic_flow_task_90_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="p">((</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">flow</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>tensor(0.8250, device=&#39;cuda:0&#39;, grad_fn=&lt;MeanBackward0&gt;)
</code></pre></div>

<h1 id="evaluating-trained-networks">Evaluating trained networks<a class="headerlink" href="#evaluating-trained-networks" title="Permanent link">&para;</a></h1>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">flyvision</span> <span class="kn">import</span> <span class="n">results_dir</span>
<span class="kn">from</span> <span class="nn">flyvision.network</span> <span class="kn">import</span> <span class="n">NetworkView</span>
<span class="kn">from</span> <span class="nn">flyvision.utils.activity_utils</span> <span class="kn">import</span> <span class="n">LayerActivity</span>

<span class="kn">from</span> <span class="nn">flyvision.datasets.sintel</span> <span class="kn">import</span> <span class="n">MultiTaskSintel</span>
<span class="kn">from</span> <span class="nn">flyvision.decoder</span> <span class="kn">import</span> <span class="n">DecoderGAVP</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># we load the best task-performing model from the presorted ensemble</span>
<span class="n">network_view</span> <span class="o">=</span> <span class="n">NetworkView</span><span class="p">(</span><span class="n">results_dir</span> <span class="o">/</span> <span class="s2">&quot;flow/0000/000&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[2024-09-23 15:54:46] network:1005 Initialized network view at /groups/turaga/home/lappalainenj/FlyVis/private/flyvision/data/results/flow/0000/000.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">network</span> <span class="o">=</span> <span class="n">network_view</span><span class="o">.</span><span class="n">init_network</span><span class="p">()</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[2024-09-23 15:54:55] network:252 Initialized network with NumberOfParams(free=734, fixed=2959) parameters.
[2024-09-23 15:54:55] chkpt_utils:72 Recovered network state.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">decoder</span> <span class="o">=</span> <span class="n">network_view</span><span class="o">.</span><span class="n">init_decoder</span><span class="p">()[</span><span class="s2">&quot;flow&quot;</span><span class="p">]</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[2024-09-23 15:54:56] chkpt_utils:72 Recovered network state.
[2024-09-23 15:55:00] decoder:213 Initialized decoder with NumberOfParams(free=7427, fixed=0) parameters.
[2024-09-23 15:55:00] decoder:214 DecoderGAVP(
  (base): Sequential(
    (0): Conv2dHexSpace(34, 8, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2))
    (1): BatchNorm2d(8, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (2): Softplus(beta=1, threshold=20)
    (3): Dropout(p=0.5, inplace=False)
  )
  (decoder): Sequential(
    (0): Conv2dHexSpace(8, 3, kernel_size=(5, 5), stride=(1, 1), padding=(2, 2))
  )
  (head): Sequential()
)
[2024-09-23 15:55:00] chkpt_utils:91 Recovered flow decoder state.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">dataset</span> <span class="o">=</span> <span class="n">MultiTaskSintel</span><span class="p">(</span>
    <span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">],</span>
    <span class="n">boxfilter</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">13</span><span class="p">),</span>
    <span class="n">vertical_splits</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">all_frames</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">n_frames</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">augment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">resampling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">interpolate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">lum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;lum&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;flow&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>

<span class="n">stationary_state</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">fade_in_state</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">lum</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">responses</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">lum</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">initial_state</span><span class="o">=</span><span class="n">stationary_state</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">y_pred</span> <span class="o">=</span> <span class="n">decoder</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span>
</code></pre></div>
<p>We expect this network to generalize across sequences. This network sees motion into all directions.</p>
<div class="highlight"><pre><span></span><code><span class="n">animation</span> <span class="o">=</span> <span class="n">SintelSample</span><span class="p">(</span><span class="n">lum</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">prediction</span><span class="o">=</span><span class="n">y_pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
<span class="n">animation</span><span class="o">.</span><span class="n">animate_in_notebook</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="../02_flyvision_optic_flow_task_files/02_flyvision_optic_flow_task_101_0.png" /></p>
<p>We expect the accuracy is not as good as the overfitted example because this network generalized across the whole-dataset.</p>
<div class="highlight"><pre><span></span><code><span class="p">((</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">flow</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>tensor(6.4063, device=&#39;cuda:0&#39;, grad_fn=&lt;MeanBackward0&gt;)
</code></pre></div>

<h1 id="evaluating-ensembles">Evaluating ensembles<a class="headerlink" href="#evaluating-ensembles" title="Permanent link">&para;</a></h1>
<p>Last, we evaluated the task error of the 50 trained networks on a held out set of sequences. We evaluated the task error across all checkpoints during training and show the minimal one in the histrogram below. This checkpoint we analyse with respect to it&rsquo;s tuning predictions as shown in the next notebooks.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">flyvision</span> <span class="kn">import</span> <span class="n">EnsembleView</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">ensemble</span> <span class="o">=</span> <span class="n">EnsembleView</span><span class="p">(</span><span class="n">results_dir</span> <span class="o">/</span> <span class="s2">&quot;flow/0000&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>Loading ensemble:   0%|          | 0/50 [00:00&lt;?, ?it/s]


[2024-09-23 15:57:24] ensemble:138 Loaded 50 networks.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">ensemble</span><span class="o">.</span><span class="n">task_error_histogram</span><span class="p">()</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>(&lt;Figure size 300x300 with 1 Axes&gt;,
 &lt;Axes: xlabel=&#39;task error&#39;, ylabel=&#39;number models&#39;&gt;)
</code></pre></div>

<p><img alt="png" src="../02_flyvision_optic_flow_task_files/02_flyvision_optic_flow_task_108_1.png" /></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.d6f25eb3.min.js"></script>
      
    
  </body>
</html>