
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://flyvis.github.io/examples/06_flyvision_maximally_excitatory_stimuli/">
      
      
        <link rel="prev" href="../05_flyvision_umap_and_clustering_models/">
      
      
        <link rel="next" href="../07_flyvision_providing_custom_stimuli/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.38">
    
    
      
        <title>Maximally excitatory stimuli - Flyvis</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8c3ca2c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#maximally-excitatory-stimuli-from-trained-models" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Flyvis" class="md-header__button md-logo" aria-label="Flyvis" data-md-component="logo">
      
  <img src="../../images/logo_hexagon.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Flyvis
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Maximally excitatory stimuli
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Flyvis" class="md-nav__button md-logo" aria-label="Flyvis" data-md-component="logo">
      
  <img src="../../images/logo_hexagon.jpg" alt="logo">

    </a>
    Flyvis
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../01_flyvision_connectome/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Explore the connectome
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../02_flyvision_optic_flow_task/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Train the network
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../03_flyvision_flash_responses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flash responses
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../04_flyvision_moving_edge_responses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Moving edge responses
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../05_flyvision_umap_and_clustering_models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ensemble clustering
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Maximally excitatory stimuli
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../07_flyvision_providing_custom_stimuli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Custom stimuli
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contribute/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/connectome/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Connectome
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/network/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Network
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/sintel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sintel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/tasks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Task
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/solver/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Task Training
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/flash_responses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flash Responses
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/moving_stimulus_responses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Moving Stimulus Responses
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/ensemble_clustering/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ensemble Clustering
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/optimal_stimuli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimal Stimuli
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FAQ
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../acknowledgements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Acknowledgements
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">load_ext</span> <span class="n">autoreload</span>
<span class="o">%</span><span class="n">autoreload</span> <span class="mi">2</span>
</code></pre></div>
<h1 id="maximally-excitatory-stimuli-from-trained-models">Maximally excitatory stimuli from trained models<a class="headerlink" href="#maximally-excitatory-stimuli-from-trained-models" title="Permanent link">&para;</a></h1>
<p>This notebook illustrates how to compute the stimuli that maximally excite a specific neuron.</p>
<p><strong>Select GPU runtime</strong></p>
<p>To run the notebook on a GPU select Menu -&gt; Runtime -&gt; Change runtime type -&gt; GPU.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># @markdown **Check access to GPU**</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">google.colab</span>

    <span class="n">IN_COLAB</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">IN_COLAB</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">torch</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">cuda_name</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_name</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Name of the assigned GPU / CUDA device: </span><span class="si">{</span><span class="n">cuda_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">warnings</span>

        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;You have not selected Runtime Type: &#39;GPU&#39; or Google could not assign you one. Please revisit the settings as described above or proceed on CPU (slow).&quot;</span>
        <span class="p">)</span>
</code></pre></div>
<p><strong>Install Flyvis</strong></p>
<p>The notebook requires installing our package <code>flyvis</code>. You may need to restart your session after running the code block below with Menu -&gt; Runtime -&gt; Restart session. Then, imports from <code>flyvis</code> should succeed without issue.</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="n">IN_COLAB</span><span class="p">:</span>
    <span class="c1">#@markdown **Install Flyvis**</span>
    <span class="o">%%</span><span class="n">capture</span>
    <span class="err">!</span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">flyvis</span><span class="o">/</span><span class="n">flyvis</span><span class="o">-</span><span class="n">dev</span><span class="o">.</span><span class="n">git</span>
    <span class="o">%</span><span class="n">cd</span> <span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">flyvis</span><span class="o">-</span><span class="n">dev</span>
    <span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">e</span> <span class="o">.</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># basic imports</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
</code></pre></div>
<h1 id="optimal-naturalistic-stimuli">Optimal naturalistic stimuli<a class="headerlink" href="#optimal-naturalistic-stimuli" title="Permanent link">&para;</a></h1>
<p>We first find the optimal naturalistic stimuli. To do that, we simulate the responses of 
the network (including the neuron of interest) to all stimuli from a fixed dataset of stimuli. 
The optimal, or here maximally exctitatory naturalistic stimulus to be precise, is the stimulus 
for which the response of the chosen neuron is maximal. Finding this is simple and does not require numerical optimization with gradients.
We find the stimulus per cell type based on its cell in the central column. At least in our coarse model, 
the offset version of this stimulus would also maximally excite the equivalently offset neighboring cells of the same type.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">flyvision</span> <span class="kn">import</span> <span class="n">NetworkView</span><span class="p">,</span> <span class="n">results_dir</span>
<span class="kn">from</span> <span class="nn">flyvision.datasets.sintel</span> <span class="kn">import</span> <span class="n">AugmentedSintel</span>
<span class="kn">from</span> <span class="nn">flyvision.analysis.optimal_stimuli</span> <span class="kn">import</span> <span class="n">FindOptimalStimuli</span><span class="p">,</span> <span class="n">GenerateOptimalStimuli</span><span class="p">,</span>  <span class="n">plot_stim_response</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># let&#39;s load the dataset and the pretrained network</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">AugmentedSintel</span><span class="p">(</span><span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lum&quot;</span><span class="p">],</span> <span class="n">temporal_split</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">network_view</span> <span class="o">=</span> <span class="n">NetworkView</span><span class="p">(</span><span class="n">results_dir</span> <span class="o">/</span> <span class="s2">&quot;flow/0000/000&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[2024-09-25 18:08:10] network:1005 Initialized network view at /groups/turaga/home/lappalainenj/FlyVis/private/flyvision/data/results/flow/0000/000.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">findoptstim</span> <span class="o">=</span> <span class="n">FindOptimalStimuli</span><span class="p">(</span><span class="n">network_view</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[2024-09-25 18:08:20] network:252 Initialized network with NumberOfParams(free=734, fixed=2959) parameters.
[2024-09-25 18:08:20] chkpt_utils:72 Recovered network state.
</code></pre></div>

<p>For the T4c neuron, we would expect that the maximally excitatory stimulus is an ON-edge
moving upward.</p>
<div class="highlight"><pre><span></span><code><span class="n">optstim</span> <span class="o">=</span> <span class="n">network_view</span><span class="o">.</span><span class="n">optimal_stimulus_responses</span><span class="p">(</span><span class="s2">&quot;T4c&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[2024-09-25 18:08:21] logger:83 [MemorizedFunc(func=&lt;function compute_optimal_stimulus_responses at 0x7fba9d1b1dc0&gt;, location=/groups/turaga/home/lappalainenj/FlyVis/private/flyvision/data/results/flow/0000/000/__cache__)]: 
                        Querying compute_optimal_stimulus_responses with signature
                        compute_optimal_stimulus_responses(CheckpointedNetwork(network_class=&lt;class &#39;flyvision.network.Network&#39;&gt;, config={&#39;connectome&#39;: {&#39;type&#39;: &#39;ConnectomeDir&#39;, &#39;file&#39;: &#39;fib25-fib19_v2.2.json&#39;, &#39;extent&#39;: 15, &#39;n_syn_fill&#39;: 1}, &#39;dynamics&#39;: {&#39;type&#39;: &#39;PPNeuronIGRSynapses&#39;, &#39;activation&#39;: {&#39;type&#39;: &#39;relu&#39;}}, &#39;node_config&#39;: {&#39;bias&#39;: {&#39;type&#39;: &#39;RestingPotential&#39;, &#39;groupby&#39;: [&#39;type&#39;], &#39;initial_dist&#39;: &#39;Normal&#39;, &#39;mode&#39;: &#39;sample&#39;, &#39;requires_grad&#39;: True, &#39;mean&#39;: 0.5, &#39;std&#39;: 0.05, &#39;penalize&#39;: {&#39;activity&#39;: True}, &#39;seed&#39;: 0}, &#39;time_const&#39;: {&#39;type&#39;: &#39;TimeConstant&#39;, &#39;groupby&#39;: [&#39;type&#39;], &#39;initial_dist&#39;: &#39;Value&#39;, &#39;value&#39;: 0.05, &#39;requires_grad&#39;: True}}, &#39;edge_config&#39;: {&#39;sign&#39;: {&#39;type&#39;: &#39;SynapseSign&#39;, &#39;initial_dist&#39;: &#39;Value&#39;, &#39;requires_grad&#39;: False, &#39;group..., 
&#39;T4c&#39;, { &#39;boxfilter&#39;: {&#39;extent&#39;: 15, &#39;kernel_size&#39;: 13},
  &#39;dt&#39;: 0.01,
  &#39;interpolate&#39;: False,
  &#39;tasks&#39;: [&#39;lum&#39;],
  &#39;temporal_split&#39;: True}, 
&lt;class &#39;flyvision.datasets.sintel.AugmentedSintel&#39;&gt;).

                        (argument hash 2281c4887178168b7aaa6dc2c0005a0b)

                        The store location is /groups/turaga/home/lappalainenj/FlyVis/private/flyvision/data/results/flow/0000/000/__cache__/flyvision/analysis/stimulus_responses/compute_optimal_stimulus_responses.

[2024-09-25 18:08:21] logger:80 [MemorizedFunc(func=&lt;function compute_optimal_stimulus_responses at 0x7fba9d1b1dc0&gt;, location=/groups/turaga/home/lappalainenj/FlyVis/private/flyvision/data/results/flow/0000/000/__cache__)]: Computing func compute_optimal_stimulus_responses, argument hash 2281c4887178168b7aaa6dc2c0005a0b in location /groups/turaga/home/lappalainenj/FlyVis/private/flyvision/data/results/flow/0000/000/__cache__/flyvision/analysis/stimulus_responses/compute_optimal_stimulus_responses


________________________________________________________________________________
[Memory] Calling flyvision.analysis.stimulus_responses.compute_optimal_stimulus_responses...
compute_optimal_stimulus_responses(CheckpointedNetwork(network_class=&lt;class &#39;flyvision.network.Network&#39;&gt;, config={&#39;connectome&#39;: {&#39;type&#39;: &#39;ConnectomeDir&#39;, &#39;file&#39;: &#39;fib25-fib19_v2.2.json&#39;, &#39;extent&#39;: 15, &#39;n_syn_fill&#39;: 1}, &#39;dynamics&#39;: {&#39;type&#39;: &#39;PPNeuronIGRSynapses&#39;, &#39;activation&#39;: {&#39;type&#39;: &#39;relu&#39;}}, &#39;node_config&#39;: {&#39;bias&#39;: {&#39;type&#39;: &#39;RestingPotential&#39;, &#39;groupby&#39;: [&#39;type&#39;], &#39;initial_dist&#39;: &#39;Normal&#39;, &#39;mode&#39;: &#39;sample&#39;, &#39;requires_grad&#39;: True, &#39;mean&#39;: 0.5, &#39;std&#39;: 0.05, &#39;penalize&#39;: {&#39;activity&#39;: True}, &#39;seed&#39;: 0}, &#39;time_const&#39;: {&#39;type&#39;: &#39;TimeConstant&#39;, &#39;groupby&#39;: [&#39;type&#39;], &#39;initial_dist&#39;: &#39;Value&#39;, &#39;value&#39;: 0.05, &#39;requires_grad&#39;: True}}, &#39;edge_config&#39;: {&#39;sign&#39;: {&#39;type&#39;: &#39;SynapseSign&#39;, &#39;initial_dist&#39;: &#39;Value&#39;, &#39;requires_grad&#39;: False, &#39;group..., 
&#39;T4c&#39;, { &#39;boxfilter&#39;: {&#39;extent&#39;: 15, &#39;kernel_size&#39;: 13},
  &#39;dt&#39;: 0.01,
  &#39;interpolate&#39;: False,
  &#39;tasks&#39;: [&#39;lum&#39;],
  &#39;temporal_split&#39;: True}, 
&lt;class &#39;flyvision.datasets.sintel.AugmentedSintel&#39;&gt;)


[2024-09-25 18:08:21] network:1005 Initialized network view at /groups/turaga/home/lappalainenj/FlyVis/private/flyvision/data/results/flow/0000/000.
[2024-09-25 18:08:34] network:252 Initialized network with NumberOfParams(free=734, fixed=2959) parameters.
[2024-09-25 18:08:34] chkpt_utils:72 Recovered network state.
[2024-09-25 18:08:34] logger:83 [MemorizedFunc(func=&lt;function compute_responses at 0x7fba9d193670&gt;, location=/groups/turaga/home/lappalainenj/FlyVis/private/flyvision/data/results/flow/0000/000/__cache__)]: 
                        Querying compute_responses with signature
                        compute_responses(CheckpointedNetwork(network_class=&lt;class &#39;flyvision.network.Network&#39;&gt;, config={&#39;connectome&#39;: {&#39;type&#39;: &#39;ConnectomeDir&#39;, &#39;file&#39;: &#39;fib25-fib19_v2.2.json&#39;, &#39;extent&#39;: 15, &#39;n_syn_fill&#39;: 1}, &#39;dynamics&#39;: {&#39;type&#39;: &#39;PPNeuronIGRSynapses&#39;, &#39;activation&#39;: {&#39;type&#39;: &#39;relu&#39;}}, &#39;node_config&#39;: {&#39;bias&#39;: {&#39;type&#39;: &#39;RestingPotential&#39;, &#39;groupby&#39;: [&#39;type&#39;], &#39;initial_dist&#39;: &#39;Normal&#39;, &#39;mode&#39;: &#39;sample&#39;, &#39;requires_grad&#39;: True, &#39;mean&#39;: 0.5, &#39;std&#39;: 0.05, &#39;penalize&#39;: {&#39;activity&#39;: True}, &#39;seed&#39;: 0}, &#39;time_const&#39;: {&#39;type&#39;: &#39;TimeConstant&#39;, &#39;groupby&#39;: [&#39;type&#39;], &#39;initial_dist&#39;: &#39;Value&#39;, &#39;value&#39;: 0.05, &#39;requires_grad&#39;: True}}, &#39;edge_config&#39;: {&#39;sign&#39;: {&#39;type&#39;: &#39;SynapseSign&#39;, &#39;initial_dist&#39;: &#39;Value&#39;, &#39;requires_grad&#39;: False, &#39;group..., 
&lt;class &#39;flyvision.datasets.sintel.AugmentedSintel&#39;&gt;, { &#39;boxfilter&#39;: {&#39;extent&#39;: 15, &#39;kernel_size&#39;: 13},
  &#39;dt&#39;: 0.01,
  &#39;interpolate&#39;: False,
  &#39;tasks&#39;: [&#39;lum&#39;],
  &#39;temporal_split&#39;: True}, 
4, 0.0, 2.0).

                        (argument hash bef8ab0b1f1206171b1e38bf67305c6f)

                        The store location is /groups/turaga/home/lappalainenj/FlyVis/private/flyvision/data/results/flow/0000/000/__cache__/flyvision/analysis/stimulus_responses/compute_responses.

[2024-09-25 18:08:34] xarray_joblib_backend:582 Loading Dataset from NetCDF at /groups/turaga/home/lappalainenj/FlyVis/private/flyvision/data/results/flow/0000/000/__cache__/flyvision/analysis/stimulus_responses/compute_responses/bef8ab0b1f1206171b1e38bf67305c6f/output.h5


___________________________________compute_responses cache loaded - 0.0s, 0.0min
Persisting in /groups/turaga/home/lappalainenj/FlyVis/private/flyvision/data/results/flow/0000/000/__cache__/flyvision/analysis/stimulus_responses/compute_optimal_stimulus_responses/2281c4887178168b7aaa6dc2c0005a0b
______________________________compute_optimal_stimulus_responses - 43.0s, 0.7min
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">stim_resp_plot</span> <span class="o">=</span> <span class="n">plot_stim_response</span><span class="p">(</span><span class="n">optstim</span><span class="o">.</span><span class="n">stimulus</span><span class="o">.</span><span class="n">stimulus</span><span class="p">,</span> <span class="n">optstim</span><span class="o">.</span><span class="n">stimulus</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span> <span class="o">*</span><span class="n">network_view</span><span class="o">.</span><span class="n">connectome_view</span><span class="o">.</span><span class="n">get_uv</span><span class="p">(</span><span class="s2">&quot;T4c&quot;</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">],</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label_peak_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../06_flyvision_maximally_excitatory_stimuli_files/06_flyvision_maximally_excitatory_stimuli_14_0.png" /></p>
<p>We see that the the stimulus indeed contains an ON-edge component moving upward and this is the portion of the stimulus that T4c cells respond most to.
What&rsquo;s unclear is whether the other parts of the stimulus have an influence on the response.</p>
<h1 id="regularized-optimal-stimuli">Regularized optimal stimuli<a class="headerlink" href="#regularized-optimal-stimuli" title="Permanent link">&para;</a></h1>
<p>We can regularize the optimal stimuli with the objective to keep the response of the
cell intact while bringing the stimulus pixels to a neutral grey value.</p>
<div class="highlight"><pre><span></span><code><span class="n">stim_resp_plot</span> <span class="o">=</span> <span class="n">plot_stim_response</span><span class="p">(</span><span class="n">optstim</span><span class="o">.</span><span class="n">regularized_stimulus</span><span class="p">,</span> <span class="n">optstim</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span> <span class="o">*</span><span class="n">network_view</span><span class="o">.</span><span class="n">connectome_view</span><span class="o">.</span><span class="n">get_uv</span><span class="p">(</span><span class="s2">&quot;T4c&quot;</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">],</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label_peak_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../06_flyvision_maximally_excitatory_stimuli_files/06_flyvision_maximally_excitatory_stimuli_17_0.png" /></p>
<p>This looks remarkably different! Now only a central black portion follow by the ON-edge
moving upward remains in the stimulus. Let&rsquo;s make sure that the central cell response is
really the same as before! This is the entire time trace.</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">optstim</span><span class="o">.</span><span class="n">central_target_response</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">optstim</span><span class="o">.</span><span class="n">central_target_response</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">optstim</span><span class="o">.</span><span class="n">central_predicted_response</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time (s)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>Text(0, 0.5, &#39;response&#39;)
</code></pre></div>

<p><img alt="png" src="../06_flyvision_maximally_excitatory_stimuli_files/06_flyvision_maximally_excitatory_stimuli_19_1.png" /></p>
<p>This looks quite similar! One can play with the regularization optimization and its parameters of the function <code>regularized_optimal_stimuli</code>.</p>
<h1 id="generate-artificial-optimal-stimuli-from-scratch">Generate artificial optimal stimuli from scratch<a class="headerlink" href="#generate-artificial-optimal-stimuli-from-scratch" title="Permanent link">&para;</a></h1>
<p>If one is able to optimize the naturalistic stimulus with the gradient, why don&rsquo;t we
use the gradient to generate an optimal stimulus from scratch (or rather random noise).
We do that in the following. Again for T4c, we would expect that it would have some sort
of ON-edge moving upwards.</p>
<div class="highlight"><pre><span></span><code><span class="n">genoptstim</span> <span class="o">=</span> <span class="n">GenerateOptimalStimuli</span><span class="p">(</span><span class="n">network_view</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[2024-09-25 18:09:34] chkpt_utils:72 Recovered network state.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">artoptstim</span> <span class="o">=</span> <span class="n">genoptstim</span><span class="o">.</span><span class="n">artificial_optimal_stimuli</span><span class="p">(</span><span class="s2">&quot;T4c&quot;</span><span class="p">,</span> <span class="n">t_stim</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">stim_resp_plot</span> <span class="o">=</span> <span class="n">plot_stim_response</span><span class="p">(</span><span class="n">artoptstim</span><span class="o">.</span><span class="n">stimulus</span><span class="p">,</span> <span class="n">artoptstim</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span> <span class="o">*</span><span class="n">network_view</span><span class="o">.</span><span class="n">connectome_view</span><span class="o">.</span><span class="n">get_uv</span><span class="p">(</span><span class="s2">&quot;T4c&quot;</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">],</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label_peak_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../06_flyvision_maximally_excitatory_stimuli_files/06_flyvision_maximally_excitatory_stimuli_24_0.png" /></p>
<p>Wow! This stimulus is contains very similar components to the one before and is much more
saturated! It also contains new ON-components already from the beginning!</p>
<p>Last, let&rsquo;s compare which stimulus excited the neuron the most.</p>
<div class="highlight"><pre><span></span><code><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">optstim</span><span class="o">.</span><span class="n">central_target_response</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">optstim</span><span class="o">.</span><span class="n">central_target_response</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;naturalistic&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">optstim</span><span class="o">.</span><span class="n">central_predicted_response</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;regularized naturalistic&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">artoptstim</span><span class="o">.</span><span class="n">response</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">artoptstim</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;artificial&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;time (s)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>&lt;matplotlib.legend.Legend at 0x7fba75d0d7f0&gt;
</code></pre></div>

<p><img alt="png" src="../06_flyvision_maximally_excitatory_stimuli_files/06_flyvision_maximally_excitatory_stimuli_26_1.png" /></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.d6f25eb3.min.js"></script>
      
    
  </body>
</html>